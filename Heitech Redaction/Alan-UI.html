
{% extends "base.html" %}

<!-- 
CDF Medical Document Redaction System - Version 5
Enhanced Human Review Interface with Inline Editing
-->

{% block title %}Human Review - {{ filename }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-user-edit text-primary"></i> B4/B6 Classification Review</h2>
                <p class="text-muted">File: <strong>{{ filename }}</strong></p>
            </div>
            <div class="review-controls">
                <button class="btn btn-warning btn-sm" onclick="undoLastAction()" id="undoBtn" disabled>
                    <i class="fas fa-undo"></i> Undo
                </button>
                <button class="btn btn-secondary btn-sm" onclick="resetAllChanges()" id="resetBtn">
                    <i class="fas fa-refresh"></i> Reset All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Display -->
<div class="row mb-3">
    <div class="col-12">
        <div class="shortcuts-panel">
            <h6><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h6>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <kbd>Cmd/Ctrl+X</kbd>
                    <span>Cut Selection</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Cmd/Ctrl+C</kbd>
                    <span>Copy Selection</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Cmd/Ctrl+V</kbd>
                    <span>Paste Text</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Cmd/Ctrl+Z</kbd>
                    <span>Undo Last Action</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Drag</kbd>
                    <span>Select Multiple Words</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Click</kbd>
                    <span>Select Single Word</span>
                </div>
            </div>
            
            <div class="modal-shortcuts">
                <h6><i class="fas fa-modal"></i> In Classification Modal</h6>
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <kbd>B or 4</kbd>
                        <span>Mark as B4 (Trade Secret)</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>P or 6</kbd>
                        <span>Mark as B6 (Patient Info)</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>U</kbd>
                        <span>Unredact Selection</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Esc</kbd>
                        <span>Close Modal</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="progress-card">
            <h5><i class="fas fa-tasks"></i> Review Progress</h5>
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-value" id="b4Count">0</span>
                    <span class="stat-label">B4 Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="b6Count">0</span>
                    <span class="stat-label">B6 Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="totalChanges">0</span>
                    <span class="stat-label">Changes Made</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="legend-card">
            <h6><i class="fas fa-palette"></i> Classification Guide</h6>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="classification-demo b4"></span>
                    <div>
                        <strong>B4 - Trade Secrets</strong>
                        <small>Manufacturing, formulas, commercial data</small>
                    </div>
                </div>
                <div class="legend-item">
                    <span class="classification-demo b6"></span>
                    <div>
                        <strong>B6 - Patient Information</strong>
                        <small>Patient names, medical personnel, facilities</small>
                    </div>
                </div>
                <div class="legend-item">
                    <span class="classification-demo manually-added"></span>
                    <div>
                        <strong>Manually Edited</strong>
                        <small>Items you've manually classified or edited</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Field-by-field review with inline editing -->
{% for field_id, word_data in review_word_data.items() %}
<div class="row mb-4">
    <div class="col-12">
        <div class="field-review-panel">
            <div class="field-header">
                <h4>
                    <i class="fas fa-file-alt"></i> 
                    {{ target_fields.get(field_id, field_id) }} ({{ field_id }})
                </h4>
                <p class="text-muted">
                    <strong>Instructions:</strong> Edit text naturally, drag to select multiple words, 
                    or click individual words. Use keyboard shortcuts for quick classification.
                    <span class="field-status" id="status-{{ field_id }}"></span>
                </p>
            </div>
            
            <div class="editable-field" 
                 contenteditable="true" 
                 data-field-id="{{ field_id }}"
                 id="field-{{ field_id }}"
                 spellcheck="false">
                {% for word in word_data -%}
                    {%- if word.is_redacted -%}
                        <span class="redacted {{ word.redaction_type.lower() }}{% if word.manually_added %} manually-added{% endif %}" 
                              data-redaction-type="{{ word.redaction_type }}" 
                              data-original-id="{{ word.id }}">{{ word.text }}</span>
                    {%- else -%}
                        {{ word.text }}
                    {%- endif -%}
                    {%- if not loop.last %} {% endif -%}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<div class="row mt-4">
    <div class="col-12">
        <div class="action-panel">
            <div class="d-flex justify-content-between align-items-center">
                <div class="selection-info">
                    <span id="selectionStatus" class="text-muted">No text selected</span>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Back to Results
                    </button>
                    <button type="button" class="btn btn-success btn-lg" onclick="finalizeReview()">
                        <i class="fas fa-check"></i> Complete Review
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Classification Selection Modal -->
<div class="modal fade" id="classificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Classification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Classifying: <strong id="modalSelectionText"></strong></p>
                <div class="classification-options">
                    <button type="button" class="btn btn-warning classification-btn" 
                            data-type="B4">
                        <i class="fas fa-industry"></i> B4 - Trade Secret
                        <small class="d-block">Manufacturing, commercial, formulas</small>
                    </button>
                    <button type="button" class="btn btn-info classification-btn" 
                            data-type="B6">
                        <i class="fas fa-user-md"></i> B6 - Patient Information
                        <small class="d-block">Patient names, medical personnel, facilities</small>
                    </button>
                    <button type="button" class="btn btn-secondary classification-btn" 
                            data-type="unredact">
                        <i class="fas fa-times"></i> Unredact
                        <small class="d-block">Remove redaction from selection</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Shortcuts Panel */
.shortcuts-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
}

.shortcuts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.shortcut-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.shortcut-item kbd {
    background-color: #e9ecef;
    border: 1px solid #adb5bd;
    border-radius: 3px;
    color: #495057;
    font-size: 0.75rem;
    padding: 2px 6px;
    min-width: 60px;
    text-align: center;
}

.shortcut-item span {
    font-size: 0.9rem;
    color: #6c757d;
}

.modal-shortcuts {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
}

.modal-shortcuts h6 {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 10px;
}

/* Progress and Legend Cards */
.progress-card, .legend-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    height: 100%;
}

.stats-row {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
}

.stat-item {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
}

.legend-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.legend-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.classification-demo {
    display: inline-block;
    width: 20px;
    height: 12px;
    border-radius: 3px;
    margin-top: 4px;
    flex-shrink: 0;
}

.classification-demo.b4 {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
}

.classification-demo.b6 {
    background-color: #d1ecf1;
    border: 1px solid #17a2b8;
}

.classification-demo.manually-added {
    background-color: #d4edda;
    border: 1px dashed #28a745;
}

/* Field Review Panel */
.field-review-panel {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.field-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.field-status {
    font-weight: bold;
    margin-left: 10px;
}

/* Editable Field */
.editable-field {
    line-height: 1.8;
    font-size: 1.1rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 120px;
    max-height: 400px;
    overflow-y: auto;
    padding: 20px;
    background-color: #fafafa;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    transition: border-color 0.2s ease;
}

.editable-field:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.editable-field.field-modified {
    border-color: #28a745;
}

/* Redacted Text Styling */
.redacted {
    text-decoration: line-through;
    padding: 2px 4px;
    border-radius: 3px;
    position: relative;
    cursor: pointer;
}

.redacted.b4 {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    color: #856404;
}

.redacted.b6 {
    background-color: #d1ecf1;
    border: 1px solid #17a2b8;
    color: #0c5460;
}

.redacted.manually-added {
    border-style: dashed !important;
    font-weight: bold;
}

/* Text Selection */
.text-selection {
    background-color: rgba(0,123,255,0.2);
    border-radius: 2px;
}

/* User Selection Override */
.editable-field::selection {
    background-color: rgba(0,123,255,0.3);
}

.editable-field::-moz-selection {
    background-color: rgba(0,123,255,0.3);
}

/* Action Panel */
.action-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.selection-info {
    font-style: italic;
}

/* Classification Modal */
.classification-options {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.classification-btn {
    padding: 15px 20px;
    text-align: center;
    border-radius: 8px;
    flex: 1;
    min-width: 150px;
    max-width: 200px;
}

.classification-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Responsive Design */
@media (max-width: 768px) {
    .shortcuts-grid {
        grid-template-columns: 1fr;
    }
    
    .classification-options {
        flex-direction: column;
    }
    
    .classification-btn {
        max-width: none;
    }
}
</style>

<script>
let actionHistory = [];
let currentSelection = null;
let isDragging = false;
const sessionId = '{{ session_id }}';

// Initialize the interface
document.addEventListener('DOMContentLoaded', function() {
    initializeEditableFields();
    updateStats();
    console.log('Enhanced human review interface initialized');
});

function initializeEditableFields() {
    const editableFields = document.querySelectorAll('.editable-field');
    
    editableFields.forEach(field => {
        // Handle text selection and clicks
        field.addEventListener('mousedown', handleMouseDown);
        field.addEventListener('mouseup', handleMouseUp);
        field.addEventListener('mousemove', handleMouseMove);
        
        // Handle content changes
        field.addEventListener('input', handleContentChange);
        field.addEventListener('blur', handleFieldBlur);
        
        // Handle keyboard shortcuts
        field.addEventListener('keydown', handleKeyboardShortcuts);
        
        // Handle paste events (strip formatting)
        field.addEventListener('paste', handlePaste);
    });
    
    // Global keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
}

function handleMouseDown(e) {
    isDragging = true;
    currentSelection = null;
}

function handleMouseMove(e) {
    if (isDragging) {
        updateSelectionStatus();
    }
}

function handleMouseUp(e) {
    isDragging = false;
    const selection = window.getSelection();
    
    if (selection.toString().trim().length > 0) {
        currentSelection = {
            text: selection.toString().trim(),
            range: selection.getRangeAt(0),
            field: e.target.closest('.editable-field')
        };
        updateSelectionStatus();
        
        // Show classification modal for non-empty selections
        if (currentSelection.text.length > 0) {
            showClassificationModal();
        }
    } else {
        currentSelection = null;
        updateSelectionStatus();
    }
}

function handleContentChange(e) {
    const field = e.target;
    field.classList.add('field-modified');
    
    // Mark as modified
    const fieldId = field.dataset.fieldId;
    const statusElement = document.getElementById(`status-${fieldId}`);
    if (statusElement) {
        statusElement.textContent = '(Modified)';
        statusElement.style.color = '#28a745';
    }
    
    // Auto-save after a delay
    clearTimeout(field.saveTimeout);
    field.saveTimeout = setTimeout(() => {
        saveFieldContent(field);
    }, 2000);
}

function handleFieldBlur(e) {
    const field = e.target;
    saveFieldContent(field);
}

function handleKeyboardShortcuts(e) {
    // Handle modal shortcuts (when modal is open)
    const modal = document.getElementById('classificationModal');
    const isModalOpen = modal && modal.classList.contains('show');
    
    if (isModalOpen) {
        switch(e.key.toLowerCase()) {
            case 'b':
            case '4':
                e.preventDefault();
                classifySelection('B4');
                break;
            case 'p':
            case '6':
                e.preventDefault();
                classifySelection('B6');
                break;
            case 'u':
                e.preventDefault();
                classifySelection('unredact');
                break;
            case 'escape':
                e.preventDefault();
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
                break;
        }
        return;
    }
    
    // Handle standard shortcuts (when modal is closed)
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case 'x':
                e.preventDefault();
                cutSelection();
                break;
            case 'c':
                e.preventDefault();
                copySelection();
                break;
            case 'v':
                // Paste is handled by handlePaste function
                break;
            case 'z':
                if (!e.shiftKey) {
                    e.preventDefault();
                    undoLastAction();
                }
                break;
        }
    }
}

function handlePaste(e) {
    e.preventDefault();
    
    // Get plain text and insert it
    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
    const cleanText = text.replace(/\n/g, ' ').replace(/\s+/g, ' ');
    
    document.execCommand('insertText', false, cleanText);
}

function showClassificationModal() {
    if (!currentSelection || !currentSelection.text) return;
    
    const modal = document.getElementById('classificationModal');
    const modalText = document.getElementById('modalSelectionText');
    
    modalText.textContent = currentSelection.text.length > 50 
        ? currentSelection.text.substring(0, 50) + '...' 
        : currentSelection.text;
    
    new bootstrap.Modal(modal).show();
}

function cutSelection() {
    if (!currentSelection || !currentSelection.text) return;
    
    // Copy to clipboard first
    copySelection();
    
    // Store action for undo
    const beforeState = currentSelection.field.innerHTML;
    actionHistory.push({
        type: 'cut',
        field: currentSelection.field,
        beforeState: beforeState,
        text: currentSelection.text
    });
    
    // Remove the selected text
    const range = currentSelection.range;
    range.deleteContents();
    
    // Mark field as modified
    currentSelection.field.classList.add('field-modified');
    
    // Clear selection and update
    window.getSelection().removeAllRanges();
    currentSelection = null;
    updateSelectionStatus();
    updateStats();
    enableUndo();
}

function copySelection() {
    if (!currentSelection || !currentSelection.text) return;
    
    // Copy to clipboard using the modern Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentSelection.text).then(() => {
            console.log('Text copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            // Fallback to older method
            fallbackCopyText(currentSelection.text);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyText(currentSelection.text);
    }
}

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        console.log('Text copied to clipboard (fallback)');
    } catch (err) {
        console.error('Fallback copy failed: ', err);
    }
    
    document.body.removeChild(textArea);
}

function classifySelection(classificationType) {
    if (!currentSelection || !currentSelection.text) return;
    
    // Store action for undo
    const beforeState = currentSelection.field.innerHTML;
    actionHistory.push({
        type: 'classification',
        field: currentSelection.field,
        beforeState: beforeState,
        action: classificationType,
        text: currentSelection.text
    });
    
    if (classificationType === 'unredact') {
        unredactSelection();
    } else {
        redactSelection(classificationType);
    }
    
    // Clear selection and update stats
    window.getSelection().removeAllRanges();
    currentSelection = null;
    updateSelectionStatus();
    updateStats();
    enableUndo();
    
    // Close modal if open
    const modal = bootstrap.Modal.getInstance(document.getElementById('classificationModal'));
    if (modal) {
        modal.hide();
    }
}

function redactSelection(redactionType) {
    if (!currentSelection) return;
    
    const range = currentSelection.range;
    const selectedText = range.toString();
    
    // Create redacted span
    const redactedSpan = document.createElement('span');
    redactedSpan.className = `redacted ${redactionType.toLowerCase()} manually-added`;
    redactedSpan.setAttribute('data-redaction-type', redactionType);
    redactedSpan.textContent = selectedText;
    
    // Replace selection with redacted span
    range.deleteContents();
    range.insertNode(redactedSpan);
    
    // Mark field as modified
    currentSelection.field.classList.add('field-modified');
}

function unredactSelection() {
    if (!currentSelection) return;
    
    const range = currentSelection.range;
    const container = range.commonAncestorContainer;
    
    // Find redacted spans within selection
    const redactedSpans = [];
    
    if (container.nodeType === Node.ELEMENT_NODE) {
        redactedSpans.push(...container.querySelectorAll('.redacted'));
    } else if (container.parentElement && container.parentElement.classList.contains('redacted')) {
        redactedSpans.push(container.parentElement);
    }
    
    // Remove redaction from spans
    redactedSpans.forEach(span => {
        if (range.intersectsNode(span)) {
            const textNode = document.createTextNode(span.textContent);
            span.parentNode.replaceChild(textNode, span);
        }
    });
    
    // Mark field as modified
    currentSelection.field.classList.add('field-modified');
}

function saveFieldContent(field) {
    const fieldId = field.dataset.fieldId;
    const content = field.innerHTML;
    
    // Extract text and redaction data
    const fieldData = extractFieldData(field);
    
    // Send to server
    fetch('/save_field_content', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            field_id: fieldId,
            html_content: content,
            field_data: fieldData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            field.classList.remove('field-modified');
            const statusElement = document.getElementById(`status-${fieldId}`);
            if (statusElement) {
                statusElement.textContent = '(Saved)';
                statusElement.style.color = '#6c757d';
                setTimeout(() => {
                    statusElement.textContent = '';
                }, 2000);
            }
        } else {
            console.error('Save failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
    });
}

function extractFieldData(field) {
    const redactedSpans = field.querySelectorAll('.redacted');
    const redactionData = [];
    
    redactedSpans.forEach((span, index) => {
        redactionData.push({
            text: span.textContent,
            type: span.dataset.redactionType,
            position: index,
            manually_added: span.classList.contains('manually-added')
        });
    });
    
    return {
        plain_text: field.textContent,
        redactions: redactionData
    };
}

function updateSelectionStatus() {
    const statusElement = document.getElementById('selectionStatus');
    
    if (currentSelection && currentSelection.text) {
        const wordCount = currentSelection.text.split(/\s+/).length;
        statusElement.textContent = `Selected: ${wordCount} word(s) - "${currentSelection.text.substring(0, 30)}${currentSelection.text.length > 30 ? '...' : ''}"`;
        statusElement.className = 'text-info';
    } else {
        statusElement.textContent = 'No text selected - Click and drag to select text for classification';
        statusElement.className = 'text-muted';
    }
}

function updateStats() {
    const b4Elements = document.querySelectorAll('.redacted[data-redaction-type="B4"]');
    const b6Elements = document.querySelectorAll('.redacted[data-redaction-type="B6"]');
    
    document.getElementById('b4Count').textContent = b4Elements.length;
    document.getElementById('b6Count').textContent = b6Elements.length;
    document.getElementById('totalChanges').textContent = actionHistory.length;
}

function undoLastAction() {
    if (actionHistory.length === 0) return;
    
    const lastAction = actionHistory.pop();
    
    // Restore field content
    lastAction.field.innerHTML = lastAction.beforeState;
    lastAction.field.classList.add('field-modified');
    
    updateStats();
    
    if (actionHistory.length === 0) {
        document.getElementById('undoBtn').disabled = true;
    }
}

function resetAllChanges() {
    if (confirm('Are you sure you want to reset all changes? This will restore the original content and remove all manual edits.')) {
        // Reload the page to reset to original state
        window.location.reload();
    }
}

function enableUndo() {
    document.getElementById('undoBtn').disabled = false;
}

function goBack() {
    const hasChanges = document.querySelectorAll('.field-modified').length > 0 || actionHistory.length > 0;
    
    if (hasChanges) {
        if (confirm('You have unsaved changes. Are you sure you want to go back?')) {
            window.history.back();
        }
    } else {
        window.history.back();
    }
}

function finalizeReview() {
    // Save all modified fields before finalizing
    const modifiedFields = document.querySelectorAll('.field-modified');
    let savePromises = [];
    
    modifiedFields.forEach(field => {
        const promise = new Promise((resolve) => {
            saveFieldContent(field);
            resolve();
        });
        savePromises.push(promise);
    });
    
    Promise.all(savePromises).then(() => {
        if (confirm('Finalize review and create redacted form?')) {
            window.location.href = `/finalize_review/${sessionId}`;
        }
    });
}

// Handle classification button clicks
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.classification-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const classificationType = this.dataset.type;
            classifySelection(classificationType);
        });
    });
});
</script>
{% endblock %}
